@using Spors.Blazor.Charts

@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if(IsSupported)
{
    <div style='
        min-height: @AddSuffix(Height, "px"); 
        max-height: @AddSuffix(Height, "px"); 
        min-width: @AddSuffix(Width, "px"); 
        max-width: @AddSuffix(Width, "px"); 
        background-image: radial-gradient(@CalculateRadialGradient()), conic-gradient(@CalculateConicGradient());
        border-radius: 50%;
    '></div>
}
else 
{
    if(_customFallbackContent)
    {
        @NotSupportedContent
    }
    else
    {
        <p>Your browser version is not supported.</p>
    }
}

@code {
    [Parameter]
    public int Height { get; set; }

    [Parameter]
    public int Width { get; set; }

    [Parameter]
    public int RadialWidth { get; set; }

    [Parameter]
    public List<DonutChartItem> Items { get; set; }

    [Parameter]
    public RenderFragment NotSupportedContent { get; set; }

    [Parameter]
    public bool IsSupported { get; set; }

    private bool _customFallbackContent;

    private Task<IJSObjectReference> _module;

    protected override void OnInitialized() 
    {
        Height = 50;
        Width = 50;
        RadialWidth = 25;
        Items = new();
    }

    private Task<IJSObjectReference> Module 
        => _module ??= JSRuntime.InvokeAsync<IJSObjectReference>("import", "_content/Spors.Blazor/js/spors-blazor.js").AsTask();

    public override async Task SetParametersAsync(ParameterView parameters)
    {
        bool supportCheckRequired = true;

        foreach(var param in parameters)
        {
            if (param.Name == nameof(NotSupportedContent))
                _customFallbackContent = true;
            else if (param.Name == nameof(IsSupported))
                supportCheckRequired = false;
        }

        var module = await Module;
        if (supportCheckRequired)
            IsSupported = await module.InvokeAsync<bool>("supportsProperty", "background: conic-gradient(#f06, gold);");

        await base.SetParametersAsync(parameters);
    }

    public async ValueTask DisposeAsync()
    {
        if (_module != null)
        {
            var module = await _module;
            await module.DisposeAsync();
        }
    }

    private string CalculateConicGradient() 
    {
        string inner = string.Empty;         

        for(int index = 0; index < Items.Count; index++)
        {
            DonutChartItem item = Items[index];

            if (index != 0)
                inner += ", ";

            inner += $"rgb({item.Fill.R}, {item.Fill.G}, {item.Fill.B}) {item.Percentage}%";
        }

        return inner;
    }

    private string CalculateRadialGradient() 
        => $"white {RadialWidth * 2}, transparent {(RadialWidth * 2) + 1}%";

    private string AddSuffix(object element, string suffix)
        => element.ToString() + suffix;
}
